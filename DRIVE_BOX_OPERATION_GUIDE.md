# Drive / Box 運用ガイド（顧客向け）

このガイドは、`dr-gen` を顧客環境で実行し、生成物を Drive / Box に保存して運用するための最小手順です。
（機密データを外部に出さない前提で、ローカル完結します）

## 基本方針（重要）

- 1つの意思決定 = `out/<date>__<title>__<id>/` フォルダ（4ファイル）を **1単位として保管**します。
- 生成物（特に `decision-record.md`）を **後から編集しない**ことを推奨します。
  - 変更が必要なら「新しいDRを作る」方が、履歴として一貫します。
- 改ざん検知（integrity verification）は **`manifest.json` を基準**にします。

## 生成物（4ファイル）の役割

- `decision-record.md`：人が読む本文
- `summary.json`：後で集計・一覧化するための構造化データ
- `repro.md`：再生成・検証の手順書（運用向け）
- `manifest.json`：各ファイルの SHA256 ハッシュ（改ざん検知の根拠）

## 保存場所（Drive / Box）

推奨：ドライブ上にDR専用フォルダを作り、生成フォルダをそのまま置く。

例）

- `DR/2026/` の下に、`out/<date>__<title>__<id>/` をそのまま配置
- もしくは `DR/2026-Q1/` のようにスプリント/四半期で分ける

### なぜ「フォルダごと」？

`manifest.json` は「どのファイルが正しいか」を示す台帳です。
検証するには、`manifest.json` と対象ファイルが同じ場所に揃っているのが一番確実です。

## 改ざん検知（Verify integrity）の考え方

- 生成時に、各ファイルの内容から SHA256 を計算し、`manifest.json` に保存します。
- 後から同じ計算をして一致すれば「生成時から内容が変わっていない」ことを確認できます。

重要：
- これは **改ざん防止ではなく改ざん検知**です。
- **`manifest.json` 自体が信頼できる形で固定されている**ことが前提です。

Drive / Box での現実的な固定方法：
- 編集権限を限定（作成者/管理者のみ編集可）
- Box の「ロック」機能や、Drive の共有権限で“閲覧のみ”にする
- 可能なら、アップロード後に **Drive/Box のバージョン履歴を残す**運用にする

（より強い証跡が必要なら）
- `manifest.json` の SHA256（例：`shasum -a 256 manifest.json`）だけを別の場所に転記
  - 例：チケット、議事録、メール、承認ワークフロー
  - こうすると「manifest までまとめて書き換え」されても痕跡が残りやすいです

## 検証手順（非エンジニア向け・最小）

### 1コマンド（おすすめ）

`dr-gen` をインストールしていない場合でも、`npx` で実行できます。

```bash
npx dr-gen@latest verify <outフォルダ>
```

`<outフォルダ>` を省略すると、カレントディレクトリ（`.`）を検証します。

```bash
cd <outフォルダ>
npx dr-gen@latest verify
```

OK と表示されれば一致、FAILED なら差分があります。

### 手動（ターミナルでSHAを比較）

1) Drive / Box から対象フォルダをダウンロード

2) `manifest.json` を開いて `files` の中の `sha256` を確認

3) ターミナルで SHA256 を計算して一致するか見る（macOS）

```bash
cd <outフォルダ>
shasum -a 256 decision-record.md
shasum -a 256 summary.json
shasum -a 256 repro.md
```

一致しない場合：
- 誰かがファイルを編集した
- 生成ツールのバージョンが違って内容が変わった
- 改行コードなどで差が出た

## 取引先/監査に共有する時の最小セット

基本は `decision-record.md` のみ共有で十分なことが多いです。

「改ざん検知まで含めて共有したい」場合は：
- `decision-record.md`
- `manifest.json`
- （任意）`repro.md`（検証手順が書いてある）

※機密が含まれる可能性がある場合は、`context` の書き方（抽象化・リンク化）を運用ルールで決めるのがおすすめです。

## うまく運用するコツ（形骸化防止）

- `why` と `decision`を短くても良いので必ず書く
- 機密は本文に書かず、社内チケットIDや社内資料リンクにする
- 例外が出たら「例外のDR」を別に作る（元DRを編集しない）
